<?xml version="1.0" encoding="UTF-8"?>
<language id="html-erb" _name="HTML (erb)" version="2.0" _section="Markup">
  <metadata>
    <property name="mimetypes">text/x-html-erb</property>
    <property name="globs">*.html.erb;*.rhtml</property>
    <property name="block-comment-start">&lt;!--</property>
    <property name="block-comment-end">--&gt;</property>
  </metadata>
  <styles>
    <style id="comment"  _name="Comment" map-to="xml:comment"/>
    <style id="javascript-block" _name="JavaScript code block"/>
    <style id="ruby-code" _name="Ruby code"/>
  </styles>
  <definitions>

    <context id="comment" style-ref="comment">
        <start>&lt;%=?\s*#</start>
        <end>%&gt;</end>
        <include>
            <context ref="def:in-comment"/>
        </include>
    </context>
    
    <!-- JS code inside javascript_tag -->
    <context id="javascript-block">
        <start>&lt;%= javascript_tag (do) %&gt;</start>
        <end>&lt;% (end) %&gt;</end>
        <include>
            <context sub-pattern="1" where="start" style-ref="ruby:keyword"/>
            <context sub-pattern="1" where="end" style-ref="ruby:keyword"/>
            <context ref="js:js"/>
        </include>
    </context>

    <context id="erb-block" style-ref="ruby-code" class="no-spell-check">
      <start>&lt;%</start>
      <end>%&gt;</end>
      <include>
        <context ref="ruby:ruby:*"/>
      </include>
    </context>

    <replace id="html:embedded-lang-hook" ref="erb-block"/>

    <context id="html-erb">
      <include>
        <context ref="comment"/>
        <context ref="javascript-block"/>
        <context ref="erb-block"/>
        <context ref="html:html"/>
      </include>
    </context>

  </definitions>
</language>

